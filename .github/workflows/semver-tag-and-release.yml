name: Semver tag + GitHub release (from PR labels)

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  actions: write
  pull-requests: read

concurrency:
  group: semver-tag-and-release
  cancel-in-progress: false

jobs:
  tag_and_release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      # Used only when the repo has no existing tags yet.
      INITIAL_VERSION: ${{ vars.INITIAL_VERSION || '1.2.1' }}
    steps:
      - name: Checkout merge commit (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Determine semver bump from PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name.toLowerCase());

            const has = (name) => labels.includes(name) || labels.includes(`semver:${name}`);

            core.setOutput('labels', labels.join(', '));
            // Default to patch if no explicit label is present.
            // If multiple are present, prefer the largest bump.
            let bump = 'patch';
            if (has('major')) bump = 'major';
            else if (has('minor')) bump = 'minor';
            else if (has('patch')) bump = 'patch';

            core.setOutput('bump', bump);

      - name: Check for existing tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          count="$(git tag -l 'v*' | wc -l | tr -d ' ')"
          echo "count=${count}" >> "${GITHUB_OUTPUT}"

      - name: Create initial tag (first release only)
        id: tag_initial
        if: steps.tags.outputs.count == '0'
        shell: bash
        run: |
          set -euo pipefail
          new_tag="v${INITIAL_VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${new_tag}" -m "Release ${new_tag}"
          git push origin "${new_tag}"

          echo "new_tag=${new_tag}" >> "${GITHUB_OUTPUT}"
          echo "new_version=${INITIAL_VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Bump and push tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        if: steps.tags.outputs.count != '0'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ steps.bump.outputs.bump }}
          tag_prefix: "v"

      - name: Create GitHub release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_initial.outputs.new_tag || steps.tag.outputs.new_tag }}
          generate_release_notes: true

      - name: Trigger PyPI publish workflow
        uses: actions/github-script@v7
        env:
          TAG: ${{ steps.tag_initial.outputs.new_tag || steps.tag.outputs.new_tag }}
        with:
          script: |
            const tag = process.env.TAG;
            if (!tag) {
              core.setFailed('No tag was created; cannot dispatch PyPI publish workflow.');
              return;
            }

            core.info(`Dispatching PyPI publish workflow for ${tag}`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release-pypi.yml',
              ref: 'main',
              inputs: { tag },
            });

