name: Semver tag + GitHub release (from PR labels)

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: semver-tag-and-release
  cancel-in-progress: false

jobs:
  tag_and_release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merge commit (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Determine semver bump from PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name.toLowerCase());

            const has = (name) => labels.includes(name) || labels.includes(`semver:${name}`);

            core.setOutput('labels', labels.join(', '));
            // Default to patch if no explicit label is present.
            // If multiple are present, prefer the largest bump.
            let bump = 'patch';
            if (has('major')) bump = 'major';
            else if (has('minor')) bump = 'minor';
            else if (has('patch')) bump = 'patch';

            core.setOutput('bump', bump);

      - name: Bump and push tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ steps.bump.outputs.bump }}
          tag_prefix: "v"
          initial_version: "1.2.1"

      - name: Create GitHub release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          generate_release_notes: true

