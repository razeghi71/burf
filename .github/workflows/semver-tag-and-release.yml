name: Semver tag + GitHub release (from PR labels)

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  actions: write
  pull-requests: read

concurrency:
  group: semver-tag-and-release
  cancel-in-progress: false

jobs:
  plan_release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merge commit (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Determine semver bump from PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name.toLowerCase());

            const has = (name) => labels.includes(name) || labels.includes(`semver:${name}`);

            core.setOutput('labels', labels.join(', '));
            // Default behavior: do NOT release unless an explicit semver label is present.
            // If multiple are present, prefer the largest bump.
            let bump = null;
            if (has('major')) bump = 'major';
            else if (has('minor')) bump = 'minor';
            else if (has('patch')) bump = 'patch';

            const shouldRelease = bump !== null;
            core.setOutput('should_release', shouldRelease ? 'true' : 'false');
            core.setOutput('bump', bump ?? '');

      - name: No release (no semver label present)
        if: steps.bump.outputs.should_release != 'true'
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "### No release"
            echo ""
            echo "No semver label was found on this PR, so no tag or release will be created."
            echo ""
            echo "- PR labels: \`${{ steps.bump.outputs.labels }}\`"
            echo ""
            echo "To trigger a release, add one of: \`major\`, \`minor\`, \`patch\` (or \`semver:major\`, \`semver:minor\`, \`semver:patch\`)."
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Plan next tag (dry run)
        id: plan_next
        if: steps.bump.outputs.should_release == 'true'
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ steps.bump.outputs.bump }}
          tag_prefix: "v"
          commit_sha: ${{ github.event.pull_request.merge_commit_sha }}
          dry_run: true

      - name: Publish planned tag/version
        id: planned
        if: steps.bump.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.plan_next.outputs.new_tag }}"
          version="${{ steps.plan_next.outputs.new_version }}"

          echo "new_tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "new_version=${version}" >> "${GITHUB_OUTPUT}"

          {
            echo "### Release confirmation required"
            echo ""
            echo "- Planned tag: \`${tag}\`"
            echo "- Planned version: \`${version}\`"
            echo "- Semver bump label: \`${{ steps.bump.outputs.bump }}\`"
            echo ""
            echo "Approve the next job (environment gate) to perform the actual release."
          } >> "${GITHUB_STEP_SUMMARY}"

    outputs:
      new_tag: ${{ steps.planned.outputs.new_tag }}
      new_version: ${{ steps.planned.outputs.new_version }}
      bump: ${{ steps.bump.outputs.bump }}
      should_release: ${{ steps.bump.outputs.should_release }}

  tag_and_release:
    if: github.event.pull_request.merged == true && needs.plan_release.outputs.should_release == 'true'
    needs: plan_release
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Checkout merge commit (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Bump and push tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ needs.plan_release.outputs.bump }}
          tag_prefix: "v"
          commit_sha: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Verify tag matches plan
        shell: bash
        env:
          PLANNED: ${{ needs.plan_release.outputs.new_tag }}
          ACTUAL: ${{ steps.tag.outputs.new_tag }}
        run: |
          set -euo pipefail
          if [[ -z "${ACTUAL}" ]]; then
            echo "No tag created." >&2
            exit 1
          fi
          if [[ "${PLANNED}" != "${ACTUAL}" ]]; then
            echo "Planned tag (${PLANNED}) does not match actual tag (${ACTUAL})." >&2
            exit 1
          fi

      - name: Create GitHub release (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          generate_release_notes: true

      - name: Trigger PyPI publish workflow
        uses: actions/github-script@v7
        env:
          TAG: ${{ steps.tag.outputs.new_tag }}
        with:
          script: |
            const tag = process.env.TAG;
            if (!tag) {
              core.setFailed('No tag was created; cannot dispatch PyPI publish workflow.');
              return;
            }

            core.info(`Dispatching PyPI publish workflow for ${tag}`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release-pypi.yml',
              ref: 'main',
              inputs: { tag },
            });

